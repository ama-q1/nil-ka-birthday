<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Happy Birthday, Yashnil! 🎉</title>
  <meta name="description" content="Mobile-friendly birthday page with balloons, confetti, cake, and fun modes." />
  <style>
    :root{
      /* Candy Pop theme */
      --bg1:#1a0f2e; --bg2:#2b174a;
      --accent:#ff63d2; --accent2:#ff9f43; --accent3:#66e4ff;
      --text:#f7f7ff; --muted:#c9c6d8; --card:#1b1233;
      --good:#22c55e; --bad:#ef4444;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }
    body{
      margin:0; color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at -10% -20%, rgba(255,255,255,0.05) 6%, transparent 60%),
        radial-gradient(1000px 600px at 120% 20%, rgba(255,255,255,0.04) 6%, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Single canvas for all FX (confetti + fireworks) */
    #stage{
      position:fixed; inset:0; width:100vw; height:100dvh; z-index:0; pointer-events:none;
    }

    /* Stars layer (very light) */
    #twinkles{ position:fixed; inset:0; z-index:0; pointer-events:none; }
    .twinkle{
      position:absolute; width:2px; height:2px; border-radius:50%;
      background:#fff; opacity:.25;
      box-shadow:0 0 6px currentColor, 0 0 12px currentColor;
      animation: twinkle 2.2s ease-in-out infinite;
    }
    @keyframes twinkle{
      0%,100%{ opacity:.2; transform:scale(.8) }
      50%{ opacity:1; transform:scale(1.6) }
    }

    .container{ position:relative; z-index:2; max-width:980px; margin:0 auto; padding:calc(18px + env(safe-area-inset-top)) 16px calc(24px + env(safe-area-inset-bottom)); }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border:1px solid rgba(255,255,255,0.15);
      border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.35);
      padding:18px 16px;
      backdrop-filter: blur(8px);
    }
    h1{
      margin:0 0 8px 0; font-size:clamp(24px, 6vw, 44px); line-height:1.08; letter-spacing:.3px;
      background:linear-gradient(90deg, #fff, var(--accent3), var(--accent), var(--accent2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow: 0 6px 24px rgba(0,0,0,.25);
    }
    .subtitle{
      margin:4px 0 14px 0; color:var(--muted); font-size:clamp(14px, 3.6vw, 17px);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.18);
      border-radius:999px; padding:8px 12px; color:#fff; font-weight:600; font-size:14px;
    }
    .note{ color:var(--muted); font-size:13px; }

    .actions{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      position:relative; min-height:54px; margin:12px 0 10px;
    }
    .btn{
      border:none; border-radius:12px; padding:12px 14px; min-width:44px; min-height:44px;
      background:var(--accent); color:white; font-weight:700; font-size:15px;
      cursor:pointer; transition:transform .08s ease, box-shadow .15s ease, background .2s ease, opacity .2s ease;
      box-shadow:0 6px 16px color-mix(in srgb, var(--accent) 45%, transparent);
      user-select:none; touch-action:manipulation;
    }
    .btn:hover{ transform:translateY(-2px); }
    .btn:active{ transform:translateY(0); }
    .btn.alt{ background:#2b2d5b66; backdrop-filter: blur(6px); box-shadow:0 6px 16px rgba(0,0,0,.35); }
    .btn.good{ background:var(--good); box-shadow:0 6px 16px rgba(34,197,94,.35); }
    .btn.bad{ background:var(--bad); box-shadow:0 6px 16px rgba(239,68,68,.35); }
    .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,0.25); color:#fff; }
    .btn.small{ padding:8px 10px; border-radius:10px; font-weight:600; font-size:13px; }
    .hidden{ display:none !important; }
    .dodge{ position:fixed; z-index:4; }

    .loader{
      margin-top:10px; background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:12px; padding:12px;
    }
    .bar{ width:100%; height:10px; background:rgba(255,255,255,0.15); border-radius:999px; overflow:hidden; box-shadow:inset 0 1px 2px rgba(0,0,0,0.35); }
    .bar > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent3), var(--accent2)); border-radius:999px; transition:width .2s ease; }

    /* Toasts with safe area */
    .toasts{
      position:fixed; z-index:5; right:16px; bottom:calc(16px + env(safe-area-inset-bottom));
      display:flex; flex-direction:column; gap:8px; list-style:none; margin:0; padding:0; max-width:min(86vw, 360px);
    }
    .toast{
      background:#1b1d36; color:#fff; border:1px solid rgba(255,255,255,0.15);
      border-left:6px solid var(--accent2);
      border-radius:10px; padding:10px 12px; font-size:14px;
      box-shadow:0 10px 24px rgba(0,0,0,0.35);
      animation:slideIn .25s ease both;
    }
    @keyframes slideIn{ from{ transform:translateX(12px); opacity:0; } to{ transform:translateX(0); opacity:1; } }

    /* Balloons */
    .balloon-area{ position:fixed; inset:0; pointer-events:none; z-index:1; overflow:hidden; }
    .balloon{ position:absolute; bottom:-80px; font-size:clamp(28px, 7vw, 48px); filter:drop-shadow(0 4px 8px rgba(0,0,0,.35)); }
    @keyframes floatUp{ to{ transform:translateY(-120vh) rotate(15deg); opacity:0.9; } }

    /* Cake */
    .cake-wrap{ display:grid; place-items:center; margin:10px 0 0; }
    .cake{ position:relative; width:220px; height:128px; margin:4px auto 0; transform:translateZ(0); }
    .plate{ position:absolute; left:50%; transform:translateX(-50%); bottom:-6px; width:240px; height:16px; border-radius:999px; background: radial-gradient(120px 12px at 50% 40%, #ffffffaa, #fff0 70%), linear-gradient(180deg, #e6e6ee, #a8a8bb); box-shadow:0 8px 24px rgba(0,0,0,.35); }
    .layer{ position:absolute; left:50%; transform:translateX(-50%); border-radius:16px; overflow:hidden; box-shadow: inset 0 4px 16px rgba(0,0,0,.08), 0 6px 16px rgba(0,0,0,.2); }
    .layer-bottom{ bottom:8px; width:220px; height:84px; background:linear-gradient(180deg, #ffe6f2, #ffc6de); }
    .layer-top{ bottom:80px; width:200px; height:58px; background:linear-gradient(180deg, #fff0f6, #ffd1e6); }
    .drip{ position:absolute; top:0; width:24px; height:16px; background:#ffd1e6; border-radius:0 0 12px 12px; box-shadow: inset 0 2px 3px rgba(0,0,0,.08); animation: drip 3.5s ease-in-out infinite; }
    @keyframes drip{ 0%,100%{ transform:translateY(0)} 50%{ transform:translateY(4px)} }
    .drip.d1{ left:18px } .drip.d2{ left:64px; animation-delay:.35s } .drip.d3{ right:18px; animation-delay:.7s }

    .candles{ position:absolute; left:50%; top:-16px; transform:translateX(-50%); display:flex; gap:16px; }
    .candle{ width:10px; height:36px; background:repeating-linear-gradient(45deg, #fff, #fff 6px, #ff99cc 6px, #ff99cc 12px); border-radius:6px; position:relative; box-shadow:0 2px 6px rgba(0,0,0,.25); }
    .flame{ position:absolute; left:50%; top:-16px; transform:translateX(-50%); width:12px; height:18px; background:radial-gradient(circle at 50% 60%, #fff6c0 0%, #ffd166 35%, #ff9f43 60%, transparent 70%); border-radius:50%; filter:blur(.4px) drop-shadow(0 0 8px #ffcd55); animation:flicker .16s infinite alternate; }
    @keyframes flicker{ from{ transform:translateX(-50%) scale(1) } to{ transform:translateX(-50%) scale(1.12) translateY(-1px) } }
    .flame.out{ opacity:0; transform:translateX(-50%) scale(.3) translateY(-8px); filter:blur(1px) saturate(.5); transition:all .35s ease; }

    .footer{ margin-top:18px; color:var(--muted); font-size:13px; text-align:center; }

    /* Modes */
    .wiggle{ animation:wiggle .5s ease infinite alternate; }
    @keyframes wiggle{ from{ transform:rotate(-.4deg) } to{ transform:rotate(.4deg) } }
    .shake { animation: shake .08s linear infinite; }
    @keyframes shake{ 0%,100%{ transform:translate(0,0) rotate(0deg) } 25%{ transform:translate(1px,-1px) rotate(.3deg) } 50%{ transform:translate(-1px,1px) rotate(-.3deg) } 75%{ transform:translate(.6px,-.6px) rotate(.2deg) } }
    .sos{ animation:pulse .9s ease-in-out infinite; }
    @keyframes pulse{ 0%{ box-shadow:0 0 0 rgba(239,68,68,.35) } 50%{ box-shadow:0 0 24px rgba(239,68,68,.75) } 100%{ box-shadow:0 0 0 rgba(239,68,68,.35) } }

    /* Mobile tweaks */
    @media (max-width:480px){
      .actions{ gap:8px; }
      .btn{ padding:12px 12px; font-size:14px; }
      .cake{ transform:scale(.95); }
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      .wiggle,.shake,.drip,.flicker,.twinkle{ animation:none !important; }
    }
  </style>
</head>
<body>
  <canvas id="stage"></canvas>
  <div id="twinkles" aria-hidden="true"></div>

  <div class="container">
    <div class="card">
      <div class="row" style="gap:8px;">
        <span class="pill">🎂 Birthday Mode</span>
        <span class="note">Friend: <strong id="friendTag"></strong></span>
      </div>

      <h1>Happy Birthday, <span id="name">Friend</span>! 🎉</h1>
      <p class="subtitle">Works great on phones: balloons, confetti, fireworks, a cake to blow out, and fun modes.</p>

      <div class="actions">
        <button class="btn good" id="startParty">Start Party 🎈</button>
        <button class="btn" id="annoyBtn">Annoy 😈</button>
        <button class="btn alt" id="niceBtn">Nice 😇</button>
        <button class="btn" id="blowBtn" title="Use mic if possible">Blow Candles 🎤</button>
        <button class="btn ghost small hidden" id="stopBtn">Stop Chaos 🧯</button>
        <button class="btn bad" id="giftBtn" title="totally safe gift">Open Gift 🎁</button>
      </div>

      <!-- Cake -->
      <div class="cake-wrap">
        <div class="cake" id="cake" title="Double‑tap to blow out">
          <div class="plate"></div>
          <div class="layer layer-bottom">
            <div class="drip d1"></div><div class="drip d2"></div><div class="drip d3"></div>
          </div>
          <div class="layer layer-top"></div>
          <div class="candles" id="candles">
            <div class="candle"><span class="flame"></span></div>
            <div class="candle"><span class="flame"></span></div>
            <div class="candle"><span class="flame"></span></div>
          </div>
        </div>
        <small class="note">Tip: Double‑tap the cake or use the mic button to blow out the candles.</small>
      </div>

      <div id="fakeLoader" class="loader hidden">
        <div class="bar"><span id="progress"></span></div>
        <p id="loaderText" class="note">Unwrapping your legendary gift…</p>
      </div>

      <p class="note">Try to tap the gift. It dodges like your diet dodges cake.</p>
    </div>

    <p class="footer">Made with ❤️ and chaos by your friend. Enjoy, <span id="footName"></span>!</p>
  </div>

  <ul class="toasts" id="toasts"></ul>
  <div class="balloon-area" id="balloonArea" aria-hidden="true"></div>

  <!-- Nice mode modal -->
  <div class="modal hidden" id="niceModal" style="display:none;">
    <div class="content">
      <h2>Okay, pause the chaos. 🫶</h2>
      <p id="niceMsg">
        Wishing you an amazing year ahead, full of laughs, wins, and great memories.
        You make life better just by being you. Happy Birthday, <strong id="niceName"></strong>! 🎂✨
      </p>
      <button class="btn good" id="closeNice">Back to party 🎉</button>
    </div>
  </div>

  <script>
  // ---- Config ----
  const friendName = "Yashnil Gandu"; // Change this if needed
  const displayName = friendName.split(" ")[0] || friendName;

  // ---- DOM ----
  const stage = document.getElementById('stage');
  const sctx = stage.getContext('2d');
  const twinkles = document.getElementById('twinkles');
  const startBtn = document.getElementById('startParty');
  const annoyBtn = document.getElementById('annoyBtn');
  const stopBtn = document.getElementById('stopBtn');
  const giftBtn = document.getElementById('giftBtn');
  const niceBtn = document.getElementById('niceBtn');
  const niceModal = document.getElementById('niceModal');
  const closeNice = document.getElementById('closeNice');
  const toasts = document.getElementById('toasts');
  const balloonArea = document.getElementById('balloonArea');
  const loader = document.getElementById('fakeLoader');
  const progressBar = document.getElementById('progress');
  const loaderText = document.getElementById('loaderText');
  const nameEl = document.getElementById('name');
  const footName = document.getElementById('footName');
  const friendTag = document.getElementById('friendTag');
  const niceName = document.getElementById('niceName');
  const cake = document.getElementById('cake');
  const candles = document.getElementById('candles');
  const blowBtn = document.getElementById('blowBtn');

  nameEl.textContent = displayName;
  footName.textContent = displayName;
  friendTag.textContent = friendName;
  niceName.textContent = displayName;

  // ---- Device flags ----
  const IS_MOBILE = matchMedia('(pointer: coarse)').matches || innerWidth < 768;
  const REDUCED = matchMedia('(prefers-reduced-motion: reduce)').matches;

  // ---- Stage sizing (retina) ----
  function sizeStage(){
    const dpr = Math.min(devicePixelRatio || 1, 2);
    const w = innerWidth;
    const h = innerHeight; // 100dvh via CSS
    stage.width = Math.floor(w * dpr);
    stage.height = Math.floor(h * dpr);
    stage.style.width = w + 'px';
    stage.style.height = h + 'px';
    sctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  sizeStage();
  window.addEventListener('resize', sizeStage);
  if (window.visualViewport) visualViewport.addEventListener('resize', sizeStage);

  // ---- Twinkles (lightweight) ----
  function spawnTwinkles(n = IS_MOBILE ? 50 : 80){
    twinkles.innerHTML = '';
    const colors = ['#ffffff','#ffe6ff','#e6f7ff','#fff0cc'];
    for(let i=0;i<n;i++){
      const s = 1 + Math.random()*2;
      const d = 1.8 + Math.random()*2.2;
      const el = document.createElement('div');
      el.className = 'twinkle';
      el.style.width = el.style.height = s+'px';
      el.style.left = (Math.random()*100)+'vw';
      el.style.top = (Math.random()*100)+'vh';
      el.style.animationDuration = REDUCED ? '0s' : d+'s';
      el.style.animationDelay = (-Math.random()*d)+'s';
      el.style.color = colors[(Math.random()*colors.length)|0];
      twinkles.appendChild(el);
    }
  }
  spawnTwinkles();

  // ---- FX (confetti + fireworks) ----
  const confetti = [];
  const sparks = [];
  let confettiBoost = false;

  const CONFETTI_COUNT = REDUCED ? 0 : (IS_MOBILE ? 70 : 120);

  function makePiece(){
    return {
      x: Math.random()*innerWidth,
      y: Math.random()*innerHeight - innerHeight,
      w: 6 + Math.random()*6,
      h: 8 + Math.random()*12,
      color: ["#ff6b6b","#ffd166","#7c5cff","#4dd4ff","#a0f0a0"][(Math.random()*5)|0],
      speed: 1 + Math.random()*2.2,
      rot: Math.random()*Math.PI*2,
      rotSpd: (Math.random()*0.1)-0.05
    };
  }
  for(let i=0;i<CONFETTI_COUNT;i++) confetti.push(makePiece());

  function launchFirework(x=Math.random()*innerWidth*0.8+innerWidth*0.1, y=innerHeight*(0.25+Math.random()*0.2)){
    if (REDUCED) return;
    const colors = ['#ff6b6b','#ffd166','#7c5cff','#66e4ff','#22c55e','#ff63d2','#ff9f43'];
    const base = colors[(Math.random()*colors.length)|0];
    const count = IS_MOBILE ? 40 + (Math.random()*25|0) : 70 + (Math.random()*40|0);
    for(let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2;
      const spd = 1.5 + Math.random()*(IS_MOBILE?2.4:3.4);
      sparks.push({
        x, y, vx: Math.cos(ang)*spd, vy: Math.sin(ang)*spd,
        life: 50 + (Math.random()*25|0), maxLife: 50 + (Math.random()*25|0),
        color: base, size: 1 + Math.random()*1.6
      });
    }
  }
  function fireworksBurst(n=IS_MOBILE?3:5){
    for(let i=0;i<n;i++){
      setTimeout(()=> launchFirework(), i*220);
    }
  }

  // RAF render (skips frames on mobile to save battery)
  let last = performance.now();
  function render(now){
    const dt = now - last;
    if (IS_MOBILE && dt < 22) { requestAnimationFrame(render); return; } // ~45fps cap
    last = now;

    sctx.clearRect(0,0,innerWidth,innerHeight);

    // confetti
    for(const p of confetti){
      p.y += p.speed + (confettiBoost? 1.0:0);
      p.rot += p.rotSpd;
      if(p.y > innerHeight+20){ p.y = -20; p.x = Math.random()*innerWidth; }
      sctx.save(); sctx.translate(p.x,p.y); sctx.rotate(p.rot);
      sctx.fillStyle = p.color; sctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); sctx.restore();
    }

    // fireworks
    for(let i=sparks.length-1;i>=0;i--){
      const p = sparks[i];
      p.x += p.vx; p.y += p.vy;
      p.vx *= 0.985; p.vy = p.vy*0.985 + 0.015;
      p.life--;
      const a = Math.max(0, p.life/p.maxLife);
      sctx.globalAlpha = a;
      sctx.fillStyle = p.color;
      sctx.beginPath(); sctx.arc(p.x, p.y, p.size, 0, Math.PI*2); sctx.fill();
      if(p.life<=0) sparks.splice(i,1);
    }
    sctx.globalAlpha = 1;

    requestAnimationFrame(render);
  }
  requestAnimationFrame(render);

  // ---- Balloons (emoji) ----
  function spawnBalloon(){
    const b = document.createElement('div');
    b.className = 'balloon'; b.textContent = '🎈';
    b.style.left = (Math.random()*100)+'vw';
    const dur = 9 + Math.random()*5;
    b.style.animation = REDUCED ? 'none' : `floatUp ${dur}s linear forwards`;
    balloonArea.appendChild(b);
    setTimeout(()=> b.remove(), (REDUCED? 1000 : dur*1000 + 800));
  }
  function burstOfBalloons(count=IS_MOBILE?10:14){
    for(let i=0;i<count;i++) setTimeout(spawnBalloon, i*180);
  }

  // ---- Toasts ----
  const roastLines = [
    "Another lap around the sun. No refunds. ✨",
    "Got you the perfect gift: this annoying website. You’re welcome. 😌",
    "Aging like fine code: a few bugs, still lovable. 💻",
    "Your cake called. It’s filing for overtime. 🍰",
    "May your battery last longer than your phone’s. 🔋",
    "You’re not old—just well seasoned. 🧂",
    "Level up achieved. +1 charisma, +2 chaos. 🎮",
    "If birthdays were updates: ‘important security fixes’. 🔧",
    "Dance like nobody cached it. 🕺",
    "Warning: candles may require a fire permit. 🧯"
  ];
  function toast(msg, ms=3400){
    const li = document.createElement('li'); li.className='toast'; li.textContent=msg;
    toasts.appendChild(li); if(toasts.children.length>4) toasts.firstElementChild?.remove();
    setTimeout(()=> li.remove(), ms);
  }

  // ---- Title prank ----
  const origTitle = document.title;
  window.addEventListener('blur', ()=> { document.title = "Hey, come back, it's your birthday! 🎂"; });
  window.addEventListener('focus', ()=> { document.title = origTitle; });

  // ---- Audio (melody) ----
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }
  const freq = {'C4':261.63,'D4':293.66,'E4':329.63,'F4':349.23,'G4':392.00,'A4':440.00,'B4':493.88,'C5':523.25,'D5':587.33,'E5':659.25,'F5':698.46,'G5':783.99};
  const melody = [
    ['G4',0.34],['G4',0.34],['A4',0.5],['G4',0.5],['C5',0.5],['B4',0.8],
    ['G4',0.34],['G4',0.34],['A4',0.5],['G4',0.5],['D5',0.5],['C5',0.8]
  ]; // shorter on mobile
  function playMelody(){
    try{
      ensureAudio(); audioCtx.resume?.();
      const now = audioCtx.currentTime; let t = now + 0.05;
      for(const [note,dur] of melody){
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type='sine'; o.frequency.value = freq[note] || 440; g.gain.value=0;
        o.connect(g); g.connect(audioCtx.destination); o.start(t);
        g.gain.linearRampToValueAtTime(0.10, t+0.02);
        g.gain.linearRampToValueAtTime(0.08, t+dur*0.6);
        g.gain.linearRampToValueAtTime(0.0, t+dur);
        o.stop(t+dur+0.02); t += dur + 0.04;
      }
    }catch(e){}
  }

  // ---- Modes ----
  let annoyOn = false;
  let toastInterval = null;
  let wiggleInterval = null;

  function startAnnoy(){
    if(annoyOn) return;
    annoyOn = true;
    stopBtn.classList.remove('hidden'); stopBtn.classList.add('sos');
    document.body.classList.add('wiggle'); confettiBoost = true;

    toast("Annoy Mode: ON 😈", 1600);
    toastInterval = setInterval(()=>{
      const line = roastLines[(Math.random()*roastLines.length)|0];
      toast(line, 2600);
      if(Math.random() < 0.45) spawnBalloon();
    }, IS_MOBILE ? 1600 : 1300);
    wiggleInterval = setInterval(()=>{ document.body.classList.toggle('wiggle'); }, 1000);
  }

  function stopAnnoy(){
    annoyOn = false;
    stopBtn.classList.add('hidden'); stopBtn.classList.remove('sos');
    document.body.classList.remove('wiggle');
    confettiBoost = false;

    [toastInterval, wiggleInterval].forEach(id=> id && clearInterval(id));
    toastInterval = wiggleInterval = null;

    // Reset moved buttons (gift keeps dodge)
    [startBtn, annoyBtn, niceBtn, blowBtn].forEach(el=>{
      if(!el) return; el.style.left=''; el.style.top=''; el.classList.remove('dodge');
    });
    toast("Annoy Mode: OFF 🧯", 1800);
  }

  // ---- Gift dodger (touch-friendly) ----
  let giftInit = false;
  function placeGiftRandom(){
    const pad = 16;
    const r = giftBtn.getBoundingClientRect();
    const maxX = Math.max(0, innerWidth - r.width - pad);
    const maxY = Math.max(0, innerHeight - r.height - pad - 24); // safe bottom
    const x = (pad + Math.random()*maxX)|0;
    const y = (pad + Math.random()*maxY)|0;
    giftBtn.style.left = x+'px';
    giftBtn.style.top = y+'px';
  }
  function activateDodger(){ if(giftInit) return; giftInit = true; giftBtn.classList.add('dodge'); placeGiftRandom(); }
  giftBtn.addEventListener('mouseenter', ()=>{ activateDodger(); placeGiftRandom(); });
  giftBtn.addEventListener('touchstart', ()=>{ activateDodger(); placeGiftRandom(); }, {passive:true});
  giftBtn.addEventListener('mousemove', (e)=>{
    const r = giftBtn.getBoundingClientRect(); const dx = Math.abs(e.clientX - (r.left + r.width/2)); const dy = Math.abs(e.clientY - (r.top + r.height/2));
    if(dx < 80 && dy < 40) placeGiftRandom();
  });
  giftBtn.addEventListener('click', (e)=>{ e.preventDefault(); loader.classList.remove('hidden'); fakeProgress(); });

  // ---- Fake loader ----
  let progress = 0, progressTimer = null;
  const loaderMsgs = ["Unwrapping gift…","Finding the tape edge…","Why so much bubble wrap…","Almost there… maybe…","Decrypting surprises…","99% done (emotionally)."];
  function fakeProgress(){
    if(progressTimer) clearInterval(progressTimer); progress = 0; progressBar.style.width = '0%';
    let msgIndex = 0; loaderText.textContent = loaderMsgs[msgIndex];
    progressTimer = setInterval(()=>{
      progress += (progress < 85)? (1 + Math.random()*4) : (Math.random()*1.2);
      if(progress > 99) progress = 99; progressBar.style.width = progress + '%';
      if(Math.random() < 0.15){ msgIndex = (msgIndex+1) % loaderMsgs.length; loaderText.textContent = loaderMsgs[msgIndex]; }
      if(progress >= 99){
        clearInterval(progressTimer);
        setTimeout(()=>{
          loaderText.textContent = "Fine. You earned it. 🎁"; openNice();
          setTimeout(()=> { loader.classList.add('hidden'); progressBar.style.width = '0%'; }, 400);
        }, 800);
      }
    }, 120);
  }

  // ---- Nice modal ----
  function openNice(){
    niceModal.classList.remove('hidden'); niceModal.style.display = 'grid';
  }
  function closeNiceModal(){
    niceModal.classList.add('hidden'); niceModal.style.display = 'none';
  }
  niceBtn.addEventListener('click', openNice);
  (closeNice||{}).addEventListener?.('click', closeNiceModal);
  niceModal.addEventListener('click', (e)=>{ if(e.target === niceModal) closeNiceModal(); });

  // ---- Cake blow interactions ----
  let candlesOut = false;
  function extinguishCandles(){
    if(candlesOut) return;
    candlesOut = true;
    candles.querySelectorAll('.flame').forEach(f=> f.classList.add('out'));
    toast("Make a wish! ✨", 2000);
    fireworksBurst(IS_MOBILE?3:5); burstOfBalloons(IS_MOBILE?10:14);
    for(let i=0;i<8;i++) setTimeout(()=> puffSmoke(), i*120);
  }
  function relightCandles(){
    candlesOut = false;
    candles.querySelectorAll('.flame').forEach(f=> f.classList.remove('out'));
    toast("Candles relit 🔥", 1500);
  }
  function puffSmoke(){
    const p = document.createElement('span');
    Object.assign(p.style, {
      position:'absolute', left:(100 + Math.random()*20)+'px', top:'-10px',
      width:'10px', height:'10px', background:'radial-gradient(circle, rgba(200,200,220,.8), rgba(200,200,220,0))',
      borderRadius:'50%', filter:'blur(1px)', pointerEvents:'none', opacity:'0.9'
    });
    cake.appendChild(p);
    const dx = (Math.random()*36-18), dy = - (18 + Math.random()*36);
    p.animate([
      { transform:'translate(0,0) scale(1)', opacity:.9 },
      { transform:`translate(${dx}px, ${dy}px) scale(1.8)`, opacity:0 }
    ], { duration: 800 + Math.random()*450, easing:'ease-out' }).onfinish = ()=> p.remove();
  }

  // Double-tap to blow out (mobile-friendly)
  let lastTap = 0;
  cake.addEventListener('touchend', ()=>{
    const now = Date.now();
    if(now - lastTap < 350) extinguishCandles();
    lastTap = now;
  }, {passive:true});
  // Desktop double-click too
  cake.addEventListener('dblclick', extinguishCandles);

  // Mic blow detection (optional; needs HTTPS)
  let micStream = null, analyser = null, micRAF = null;
  async function startMicBlow(){
    if(location.protocol !== 'https:' && location.hostname !== 'localhost'){
      toast("Mic needs HTTPS. Double‑tap the cake instead. 🎂", 3500); return;
    }
    try{
      ensureAudio(); await audioCtx.resume?.();
      micStream = await navigator.mediaDevices.getUserMedia({audio:true});
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser(); analyser.fftSize = 1024; src.connect(analyser);
      const data = new Uint8Array(analyser.fftSize);
      toast("Blow at the mic to put out the candles! 🎤", 2800);
      let blowFrames = 0;
      function tick(){
        analyser.getByteTimeDomainData(data);
        let sum = 0; for(let i=0;i<data.length;i++){ const v = data[i]-128; sum += v*v; }
        const rms = Math.sqrt(sum/data.length);
        if(rms > 18) blowFrames++; else blowFrames = Math.max(0, blowFrames-1);
        if(blowFrames > 12){ extinguishCandles(); stopMic(); return; }
        micRAF = requestAnimationFrame(tick);
      }
      tick();
    }catch(err){
      toast("Mic permission denied. Double‑tap the cake instead. 🙃", 3200);
    }
  }
  function stopMic(){
    if(micRAF) cancelAnimationFrame(micRAF);
    micRAF = null;
    try{ micStream?.getTracks().forEach(t=>t.stop()); }catch(e){}
    micStream = null;
  }
  blowBtn.addEventListener('click', startMicBlow);

  // ---- Buttons ----
  startBtn.addEventListener('click', ()=>{
    confettiBoost = true; burstOfBalloons(IS_MOBILE?12:16); fireworksBurst();
    toast(`Happy Birthday, ${displayName}! 🎉`, 3200);
    try{ playMelody(); }catch(_){}
    if(candlesOut) relightCandles();
  });
  annoyBtn.addEventListener('click', startAnnoy);
  stopBtn.addEventListener('click', ()=>{ stopAnnoy(); stopMic(); });

  // ---- Toast welcome
  setTimeout(()=>toast(`Welcome, ${displayName}! Ready for fun? 😁`), 600);
  </script>
</body>
</html>
